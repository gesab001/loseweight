<html>

<head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>

</head>

<body>

<h1>Lose Weight</h1>


<input type="text" id="username" placeholder="Username"/>
<input type="password" id="password" placeholder="Password"/>
<button onclick="login()">LOGIN</button>


<form onsubmit="addWeight()" >
<input id="weight" type="number" placeholder="add weight"/>
<input type="submit" value="SUBMIT"/>
</form>



</body>

<script>

var username;
var password;
var access_token;
function login(){
  console.log("login");
  username = document.getElementById("username").value;
  password = document.getElementById("password").value;
  localStorage.setItem("username", username);
  localStorage.setItem("password", password);
  
  
  fetchData("access_token.json");
}
function addWeight(){
   var newWeight = document.getElementById("weight").value;
   var jsondata = {"weight": newWeight};
   saveDataToDropbox (username, jsondata);



}

	var html= "";
    /* When the request begins */
    function onloadstarthandler(e) {
    //   html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When the request is in progress */
    function onprogresshandler(e) {
     //   html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When the client cancels the request */
    function onaborthandler(e) {
     //   html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When server exception occurs */
    function onerrorhandler(e) {
      //  html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When the request is successfully terminated */
    function onloadhandler(e) {
      //  html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When a timeout occurs */
    function ontimeouthandler(e) {
       // html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When request is terminated regardless of success or failure */
    function onloadendhandler(e) {
       // html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* Checks current progress based on a random repetition period */
    function onreadystatechangehandler(e) {
        html = 'onreadystate: ' + JSON.stringify(e);
        console.log(html);
		alert("successfully saved to dropbox");
    }
	
function saveDataToDropbox (username, jsondata){


		   alert("saveDataToDropbox");

	       var data = jsondata;
		   data = JSON.stringify(data);
		   var username = localStorage.getItem("username");
		   var path = username + ".json";
		   //console.log("path: " + path);
		   //console.log("data: " + data);

		   //alert(data);
		   alert(data);
		   alert(path);
		   var access_token = "sl.BS0XOu4bnj66rhevO5Xz8b4ncIFtNHQfAP1m_yNhj4Ruo0CBT1DIYDROHipwphyfa_ifTGePAlr4bbtPW4b3cQ-SuqGo0edroGkHviL0z-Y-qIPjqUkaIDmclo1qQYEogoNSkWx9";
		   alert("access_token: " + access_token);
		   var client = new XMLHttpRequest();


		    
		    client.onloadstart = onloadstarthandler;
		    client.onprogress = onprogresshandler;
		    client.onabort = onaborthandler;
		    client.onerror = onerrorhandler;
		    client.onload = onloadhandler;
		    client.ontimeout = ontimeouthandler;
		    client.onloadend = onloadendhandler;
		    client.onreadystatechange = onreadystatechangehandler;

		    client.open("post", "https://content.dropboxapi.com/2/files/upload", true);

				    client.setRequestHeader("Authorization", "Bearer " + access_token); 
				    client.setRequestHeader("Dropbox-API-Arg", "{\"path\": \"/"+path+"\",\"mode\": \"overwrite\",\"autorename\": true,\"mute\": false,\"strict_conflict\": false}");
				    client.setRequestHeader("Content-Type", "application/octet-stream");

				    client.send(data);
		    

		}
		
function loadData(data){
	var ciphertext = JSON.stringify(data["jesuslovesyou"]);
	alert("ciphertext: " +ciphertext);
	var username =   localStorage.getItem("username");
    var password = localStorage.getItem("password");
	var secretKey = username + password;
	alert("secretKey: " + secretKey);
	var bytes = CryptoJS.AES.decrypt(ciphertext, secretKey);
	var decrypted_access_token = bytes.toString(CryptoJS.enc.Utf8);

    localStorage.setItem("access_token", decrypted_access_token);

	alert("access_token: " + localStorage.getItem("access_token"));
}

function fetchData(filename){
  	  alert("fetchData: " + filename);

	  alert("username: " + username);
  alert("password: " + password);
fetch(filename)
  .then((response) => response.json())
  .then(loadData);
  
}


</script>
</html>