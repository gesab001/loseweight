<html>

<head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
</head>

<body>

<h1>Lose Weight</h1>


<input type="text" id="username" placeholder="Username"/>
<input type="password" id="password" placeholder="Password"/>
<button onclick="login()">LOGIN</button>


<input id="weight" type="number" placeholder="add weight"/>
<button onclick="addWeight()">submit</button>



</body>

<script>

var username;
var password;
function login(){
  console.log("login");
  username = document.getElementById("username").value;
  password = document.getElementById("password").value;
  localStorage.setItem("username", username);
  localStorage.setItem("password", password);
  

}

function getWeightList(callback){

   var xhttp = new XMLHttpRequest();
   
   xhttp.onreadystatechange = function() {
     if (this.readyState == 4 && this.status == 200){
	    callback(JSON.parse(this.responseText));
	 }else{
	    callback(JSON.parse(this.responseText));
	 }
 
   };  
   
   
    xhttp.onerrorhandler = function(e) {
	    callback({"items": []});
	    callback(JSON.parse(this.responseText));
   }; 

   
   
   
   var callbackLoadData = function(access_token){  
      var fetched_accessToken = access_token.replace(/"/g, "");
		   var username = localStorage.getItem("username");
		   var password = localStorage.getItem("password");
		   var path = username + password + ".json";
      xhttp.open("POST", "https://content.dropboxapi.com/2/files/download", true);
      xhttp.setRequestHeader("Authorization", "Bearer " +fetched_accessToken);
      xhttp.setRequestHeader("Dropbox-API-Arg", "{\"path\": \"/"+path+"\"}");
      xhttp.send();

    }
     var callback = function(data){
      loadData(data, callbackLoadData);
    }
   fetchData("access_token.json", callback);
}

function addWeight(){
   var newWeight = document.getElementById("weight").value;

   

   var callbackWeightList = function(jsondata){
   
   
		try {
		 jsondata["items"].push(newWeight);
	   }
	   catch(err){
		 console.log(err);
		 jsondata = {"items": [newWeight]};
	   }  
	   
	         var callbackLoadData = function(access_token){  
			   saveDataToDropbox (jsondata, access_token);

    };		   

		  var callback = function(data){
			  loadData(data, callbackLoadData);
		  };
  
	     fetchData("access_token.json", callback);
   };
   getWeightList(callbackWeightList);




}

	var html= "";
    /* When the request begins */
    function onloadstarthandler(e) {
    //   html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When the request is in progress */
    function onprogresshandler(e) {
     //   html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When the client cancels the request */
    function onaborthandler(e) {
     //   html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When server exception occurs */
    function onerrorhandler(e) {
      //  html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When the request is successfully terminated */
    function onloadhandler(e) {
      //  html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When a timeout occurs */
    function ontimeouthandler(e) {
       // html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* When request is terminated regardless of success or failure */
    function onloadendhandler(e) {
       // html = 'onreadystate: ' + JSON.stringify(e);
        //console.log(html);
    }

    /* Checks current progress based on a random repetition period */
    function onreadystatechangehandler(e) {
        html = 'onreadystate: ' + JSON.stringify(e);
        console.log(html);
    }
	
function saveDataToDropbox (jsondata, access_token){



	       var data = jsondata;
		   data = JSON.stringify(data);
		   var username = localStorage.getItem("username");
		   var password = localStorage.getItem("password");
		   var path = username +password+ ".json";
		   //console.log("path: " + path);
		   //console.log("data: " + data);

		   //alert(data);

		   var fetched_accessToken = access_token.replace(/"/g, "");
		   var client = new XMLHttpRequest();


		    
		    client.onloadstart = onloadstarthandler;
		    client.onprogress = onprogresshandler;
		    client.onabort = onaborthandler;
		    client.onerror = onerrorhandler;
		    client.onload = onloadhandler;
		    client.ontimeout = ontimeouthandler;
		    client.onloadend = onloadendhandler;
		    client.onreadystatechange = onreadystatechangehandler;

		    client.open("post", "https://content.dropboxapi.com/2/files/upload", true);

				    client.setRequestHeader("Authorization", "Bearer " + fetched_accessToken); 
				    client.setRequestHeader("Dropbox-API-Arg", "{\"path\": \"/"+path+"\",\"mode\": \"overwrite\",\"autorename\": true,\"mute\": false,\"strict_conflict\": false}");
				    client.setRequestHeader("Content-Type", "application/octet-stream");

				    client.send(data);
		    

		}
		
function loadData(data, callback){
	var ciphertext = data["jesuslovesyou"];

	var username =   localStorage.getItem("username");
    var password = localStorage.getItem("password");
	var secretKey = username+password;
    var bytes = CryptoJS.AES.decrypt(ciphertext, secretKey);
	var decrypted_access_token = bytes.toString(CryptoJS.enc.Utf8);
	callback(decrypted_access_token);

}

function fetchData(filename, callback){

fetch(filename)
  .then((response) => response.json())
  .then(callback);
  
}


</script>
</html>